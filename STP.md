протокол [[Канальный уровень]]
[Принцип работы протокола STP / Habr](https://habr.com/en/post/419491/)

Основная задача STP — предотвратить появление петель на втором уровне. Как это сделать? Да просто отрубить все избыточные линки, пока они нам не понадобятся. Тут уже сразу возникает много вопросов: какой линк из двух (или трех-четырех) отрубить? Как определить, что основной линк упал, и пора включать запасной? Как понять, что в сети образовалась петля? Чтобы ответить на эти вопросы, нужно разобраться, как работает STP.

Причиной создания протокола STP стало возникновение петель на коммутаторах. Что такое петля? Определение петли звучит так: 
([Сети для самых маленьких. Часть четвертая. STP / Habr](https://habr.com/en/post/143768/))

[[Чё]] 
(пока скажу так, он определяет стоимость до каждого маршрута и выбирает самый быстрый)


--------------
**Петля коммутации (Bridging loop, Switching loop)** — состояние в сети, при котором происходит бесконечная пересылка [[FRAME]] между коммутаторами, подключенными в один и тот же сегмент сети.

-------
Из определения становится ясно, что возникновение петли создает большие проблемы — ведет к перегрузке свитчей и неработоспособности данного сегмента сети. Как возникает петля? На картинке ниже приведена топология, при которой будет возникать петля при отсутствии каких-либо защитных механизмов:

![[Pasted image 20221108143305.png]]

------------
Возникновение петли при следующих условиях:  
  
**1. Какой-либо из хостов посылает [[Бродкаст]] [[FRAME]] :**  
  
1.  К примеру, [[VPC5]] отправляет пакет с бродкастовым адресом назначения.
2.  Switch1 приняв данный пакет, должен отправить его через все порты, кроме порта, с которого пришел данный пакет. Пакет отправится через порты Gi0/0, Gi1/0.
3.  Коммутаторы Switch2, Switch3 приняв данный пакет также должны будут его разослать пакет. Таким образом Switch2, получивший пакет от Switch1 отправит его Switch3, а Switch3 отправит его Switch2.
4.  Далее, Switch2 получив пакет от Switch3, отправит его Switch1, а Switch3 получив пакет от Switch2, отправит его также Switch1. Тем самым, мы приходим к шагу 1) и она будет продолжаться бесконечно. Также все усугубляется тем, что на 4) шаге Switch1 будет иметь уже два экземляра фрейма, так как получит их и от Switch2, и от Switch3.


Шаги 1) — 4) будут повторяться бесконечно и на коммутоторах это происходит в долю секунды. Также образование петли приводит к тому, что постоянно будет меняться таблица мак-адресов на коммутаторах и мак-адрес отправителя VPC5 будет постоянно приписываться то к интерфейсу Gi0/0, то Gi1/0 или же Gi0/2( если в этот момент VPC5 будет отправлять другие пакеты). Такой цикл приведет к некорректной работе сети и всех коммутаторов. А отправка бродкастовых пакетов для хостов — это обычное дело, в качетсве примера протокол [[ARP]]. 


----------------
**2. Также петля может образоваться и без отправки бродкаст фрейма.**  
  

1.  К примеру, VPC5 отправляет фрейм с юникастовым мак-адресом назначения.
2.  Возможна ситуация, что мак-адрес назначения отсутствует в таблице мак-адресов коммутаторов. В данном случае, коммутатор будет пересылать пакет через все порты, кроме порта с которого получил данный фрейм. И получаем такую же ситуацию, как и с бродкаст фреймом.
3.  Ниже мы будем рассматривать протокол STP на коммутаторах Cisco. На них используется STP отдельно для каждого vlan-а, протокол PVST+. У нас всего один vlan, поэтому смысл от этого не меняется.

-----------------
Принцип работы данного протокола построен на том, что все избыточные каналы между коммутаторами логически блокируются и трафик через них не передается. Для построения топологии без избыточных каналов строится дерево (математический граф). Чтобы построить такое дерево вначале необходимо определить корень дерева, из которого и будет строиться граф. Поэтому первым шагом протокола STP является определение корневого коммутатора (Root Switch). Для определения Root Switch-a, коммутаторы обмениваются сообщениями BPDU. В общем, протокол STP использует два типа сообщений: [[BPDU]] — содержит информацию о коммутаторах и [[TCN]] — уведомляет о изменении топологии. Рассмотрим BPDU более детально. Про TCN более подробно поговорим ниже. При включении STP на коммутаторах, коммутаторы начинают рассылать BPDU сообщения. В данных сообщениях содержится следующая информация:

[[switch]] 

-------------
