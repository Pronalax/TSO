[Использование Sysmon для отслеживания вредоносных действий в Windows - Ipswitch](https://www.ipswitch.com/blog/tracing-malicious-activity-on-windows-with-sysmon)

[[скачивание Sysmon]] 

[[Подробности сисмона]] 

сисмон + митра https://github.com/nikseetharaman/sysmon_conf/blob/master/endurant_config.xml

https://www.youtube.com/watch?v=JzENQM7mdcY

Сисмон это инструмент.  Можно использовать журнал событий виндовс, чтобы отследить, что происходит на компьютере. Но журналы событий виндовс, создает сотни событий, таких как открытие папки , открытие файла. Так что это создает большой поток событий. Большинство из которых бесполезно. И на самом деле, он не записывает полезную информацию для каждого события.

Свифт конфигурация 

о сисмон иожно почитать тут  https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon (на 0:21 21.11.2022 - ссылка действительна) - это продукт от 1.Это продукт Microsoft от  Sysinternals , так что нам можно доверять ему

[[Чё]] 

------------------------------------------------------------------------------------------------------

Sysmon - это преждевременный системный драйвер Windows, который после того, как он будет установлен в системе, останется установленным.
Поэтому, даже, если я перезагружу машину, выключу питание или еще что-то еще.
Он будет работать, генерируя все события в моей системе, и как только все события, будут хорошо захвачены, они будут помещены в журнал Windows ,

-------------
Это хоршая важная часть, т.к. если у нас отключится питание рабочей станции, или же сервера или он перезагружен специально , сисмон остается постоянным в системе. регистрируя все события в журналы винды

-------------------

[Sysmon](https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon)- это сервис и драйвер устройства, который после установки в систему регистрирует индикаторы, которые могут значительно помочь отслеживать вредоносную активность в дополнение к общему устранению неполадок.

Одной из замечательных особенностей Sysmon является то, что он регистрирует много важных событий в одном месте. Вместо того, чтобы пытаться объединить события из разных журналов для устранения неполадок, в зависимости от искомой информации, вы можете просто просмотреть журнал Sysmon.



![[Pasted image 20221120022239.png]]




--------------------



допустим, у нас был взлом, мы 
убрали автозагрузку
почистили все подозрительные процессы
удалили вирусы

------
отдыхаем?

Но
- не знаем что узнал злоумышленник
- не знаем что изменилось в системе
- не знаем когда он придет снова
----
- Этот этап называется закрепление - злоумышленник должен был закрепиться в системе, как можно сильнее.
- закрепление в системе, это не вседа оставить на ней [[бэкдор]] , оставить код в автозагрузке.
- загрузить вирус - файлик
	- закрепление может быть поверхностным 
	- создать пользователя
	- изменить права у реально легитимных процессов  
	- отсканировать всю сеть
	- отсканить другие узлы 
	- посмотреть куда еще можно будет заломиться с внешней стороны
Даже если мы удалили все его следы: Мы вряд-ли полезем в пользователи, полезем в конфиги в настройки по всем процессам
- Это не самые очевидные вещи. Он может быть даже загружен в память.

Это может быть множество других операций , мало которых подозревает, мало кто на них будет обращать внимание.

- чтобы понять что надо дальше делать, надо спроектировать план реагирования на инцидент.



-----
Реагируем на инцидент:

- Где точка входа? (где будут другие возможные точки входа, через которые злоумышленник может зайти.  )
- Как оно распространилось? (какие способы он использует? как он переходит. Какие порты \ службы он использует? )
- Что происходило в каждой из систем? (какие действия он совершал, какие пользователи, какие конфиги менял у программ , возможно какие-то программы ставил  )

	По дефолту у нас есть стандартное средство аудита Windows.
	средства мониторинга, средства записи событий windows 
	- Стандартные средства Windows для стандартных ситуаций.


- Они применимы только для стандартных ситуаций. потому что журналирование идет очень неглубоким. Т.е сведения, которые можно достать  из журналов windows не так много


- Вот эти все логи,ю должны стекаться, в некую большую систему анализа логов.  В данном случае, чаще всего используются SIEM системы. (про SEEM-системы - раскажет Сергей - на одном из последних занятий то самое [[ELC]])
- Он будет использовать те логи, которые сняты сисмоном


Sysinternals - исследование инцедентов ИБ - сделали сисмон

![[Pasted image 20221119170934.png]]

- Установить:
sysmon -i accepteula [options]

- Посмотреть и обновить конфиг

sysmon -c [options] - если написать его без опций, то это будет просто просмотр опций!

- Удалить:
sysmon -u

------------------------



Что может делать сисмон? он может контролировать большое количество ивентов событий. 
- Создание файлов
- / удаленное создание файлов / 
- не конкретный доступ к диску
- может считать от всего этого хеши
- может блокировать сетевые процессы
- выполнять повестку сертификатов


Допустим специальные виды логирования. Впринципе штука очень мощная , удобная - которую можно использовать для формирования логов  .  Формирования потока, который будет анализировать другие инструументы, которые используются для безопасности вашей  сети. (в частности SIEM) 


Это тот инструмент, который надо устанавливать у себя до инцедентов, чтобы контролировать и знать как велась деятельность, как  действовали злоумышленники в  вашей сети и это позволит, не только выявлять процессы которые были созданы \  изменены \ которые висят  в трее ([[трея]]) (подписаны не подписаны)
 
-----------
Настройки:
	По-умолчанию регистрирует следующие события и считает хэши в SHA1:
	-    Создание процесса , завершение процесса , загрузка [[драйвер]]а, смена времени создания файла , создание удаленного потока , изменение службы Sysmon/


 
-  Дополнительно сразу можно задать журналирование сетеввых процессов (-n) / загрузку образов (-l).  Также ключ -h задает алгоритмы расчета хэшей [[хэш]]  



--------------
Как насчет конфигов?
Конфиги позволяют добавлять фильтры и отключать определенные события. 

- Установка sysmon -i accepteula c:\SysmonConfig.xml
- модификация sysmon -c c:\SysmonConfig.xml

В 9 версии - появились логические фильтры - то есть можно объединять несколько фильтров в  один большой 

![[Pasted image 20221119185030.png]]


мы задаем версию схемы - они меняютя очень быстро - сейчас актуальная версия - 4.20


Далее мы тут задаем алгоритмы расчета хэшэй. sha256 и md5

и дальше идут сами правила -> задаем фильтрацию событий 

-> создание событий (можно выбрать exclude , можно выбрать include)

- exclude - исключают из фильтрации те или иные строки. (черный список фильтрации крч.)
	- Все что мы не исключили, то все остальное проходит
- include - строка исключения ван-драйва из выдачи 



Чтобы посмотреть какая схема используется, надо смотреть Resource Hacker 

----------------
У сисмона есть ряд недостатков:
- нет встроенных инструментов для анализа
- если злоумышленник знает про такую штуку как сисмон, знает что, скорее всего в сети есть сборщики\ обработчики этих логов
То скорее всего, он предпримет некоторые шаги.






можно переименовать sysmon 

![[Pasted image 20221119191351.png]]


 Снизим возможность систем детектирования таким образом, но его еще можно узнать по номеру драйвера. Его достаточно трудно изменить.
 В независимости, от того как называется sysmon, в системе монитор ссервис -> можно его будет увидеть в описании
- Тоже самое можно сделать по ключам в реестре.
- Сисмон следит за всем -> оставляет следы в системе .
Крч можно его найти 


----------
![[Pasted image 20221119192436.png]]


У сисмона отсутствует самозащита, что чаще всего может предпринять злоумышленник? он может очистить правила в реестре 
- Правила/конфиги у сисмона лежат в реестре 


--------
Это все замечательно. Но есть минус. У сисмона нет самозащиты процесса, как например у большинства популярных av. Поэтому прибить сисмон и прекратить сбор событий задача простая


--------------
Узнать у Ивана, про хэшэкстракт, он позволяет выгружать [[хэш]]и в файлик и выгружать это все автоматом и сканировать, загружая на вирус тотал

Удобно, если использовать локально


Не совсем удобно, если загружать на сервер  и работать уже оттуда. Там большинство функций оно уже содержит
Большинство [[SIEM]] систем поддерживают логи сисмона

[[Агент]]ы ставятся и выгружают все логи

